### 哨兵

实现主从节点故障转移。如果主节点挂了，哨兵就会选举一个从节点切换成主节点，并且把新的主节点信息通知给从节点和客户端。

哨兵本身就是一个Redis服务器，又叫做观察者节点。负责监控，选主，通知

#### 哨兵集群

一般而言，哨兵是一个集群，至少需要三台哨兵节点才能构成哨兵集群，每个哨兵通过发布/订阅机制向主节点上一个名叫sentinel:hello频道发布自己的PI端口，其他哨兵通过订阅该频道来获取地址从而建立连接。哨兵每隔10秒就会向主节点发送INFO命令，主节点返回从节点列表，哨兵通过从节点列表知道了从节点地址，与所有从节点建立连接。

所以配置哨兵只需要主节点的端口号和IP地址。

#### 监控

每个哨兵每隔一秒就给所有主从节点发送PING命令，主从节点接收到PING命令后就会响应哨兵。如果某结点在规定时间内没有响应哨兵，哨兵就将其标注为**主观下线**。

如果被标注**主观下线**的结点是主节点，那么还需进一步判断主节点是否是**客观下线**（主节点可能是和哨兵之间的网络状况不好）。当某个哨兵判断主节点**主观下线**以后，就向其他哨兵发送命令，其他哨兵接收到这个命令后，根据自己和主节点的响应时间来进行投票，当票数超过配置文件中quorum的设定值以后，主节点被标记为**客观下线**。

#### 选主

当主节点被标记为**客观下线**以后，哨兵集群将选出一个leedear来执行主从故障转移。

对于标记了主节点**客观下线**的哨兵结点将成为候选者，所有的哨兵结点向候选者投票（可能同时存在多个候选者），每个哨兵结点有且只有一票，获得半数以票的且票数大于配置文件中quorum的设定值的候选者将成为leedear。

接着，Leader执行主从**故障转移**：

1. 选主新节点，从主节点之下的所有从节点中选出一个主节点。
   1. down-after-milliseconds是主从节点最大连接超时时间，超过这个时间的就断连。如果发生断连超过十次，就说明这个从节点网络状况不好。通过这种方式筛掉一些从节点进入下一轮
   2. 第一轮，slave-priority配置项可以给结节点设置优先级，一般根据服务器性能设置优先级。从剩余从节点中选出优先级最高的作为主节点。
   3. 第二轮，如果优先级最高的从节点有多个，就接着考察主从复制进度，master_repl_offset记录着主节点在循环链表中的已写入命令的位置。salve_repl_offset记录着从节点已经更新到的命令位置。这一轮就选出离master_repl_offset最近的那个salve_repl_offset所在的从节点
   4. 第三轮，如果第二轮之后还剩多个从节点，就选择节点ID最小的那个作为主节点。

leedear向选出来的那个从节点发送**“SLAVE on one”**命令，从节点接收到命令后将晋升为主节点。发送完命令的哨兵将以每秒一次的频率向晋升的主节点发送INFO命令，然后观察新主节点的响应中的角色信息，如果角色信息变成了master，leedear就知道从节点已经顺利晋升成了主节点。

#### 通知

leedear知道从节点已经顺利晋升成了主节点后，leedear会向旧主节点下所有的从节点发送**“SLAVEOF <新主节点IP> <新主节点Port>”**命令，令它们指向新主节点。至此主从切换工作完成。

接着，哨兵通过订阅/发布机制，向+switch-master频道发布新的IP地址和端口号，客户端通过订阅这个频道获取新的主节点地址。

如果未来旧主节点上线了，leedear就会向其发送**“SLAVEOF <新主节点IP> <新主节点Port>”**命令，令其指向新主节点。